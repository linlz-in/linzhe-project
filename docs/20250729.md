#### 20250728 工作日报
* 1.DolphinScheduler已完成
* 2.商品主题 商品诊断看板 任务工单
    全品价值评估支持基于三种维度（评分-金额/价格-销量/访客-销量）的分析
     店铺商品分布，聚焦核心商品和潜力商品进行运营 
      * 商品的基础信息(spu_info)
         商品id(spu_id) 三级分类(category3_id) 商品名称(spu_name) 价格(price)
      * 流量获取(cart_info  favor_info)
         商品id(spu_id) 用户id(user_id) 时间(create_time) 数量(spu_num)
      * 流量转换(order_detail  order_info)
         spu_id   order_id  spu_num   order_price  订单总金额(total_amount)
      * 客户拉新(order_info user_info)
         用户id(user_id) 用户注册时间(create_time) spu_id  下单时间(order_time)
      * 评分(comment_info  order_refund_info)
         spu_id  评价等级(appraise) 退货数量(refund_num)
      * 三种维度的分析(spu_info  order_detail)
         price  spu_num  order_price*spu_num  用户关联(user_id)
      * 单品竞争力(spu_info  order_detail  category3_id)
         同类商品的平均流量(category3_id)、平均转换率、平均好评率

create table if not exists spu_order(  
    sku_id bigint,  
    sku_name string,  
    category3_id bigint,  
    price decimal(16,2),  
    cart_count bigint, -- 加购次数（流量指标）  
    favor_count bigint, -- 收藏次数（流量指标）  
    order_num bigint, -- 销量（转化指标）  
    sales_amount decimal(16,2), -- 销售额（价值指标）  
    new_user_ratio decimal(16,2), -- 新客占比（拉新指标）  
    good_comment_rate decimal(16,2), -- 好评率（服务指标）  
    refund_rate decimal(16,2) -- 退货率（服务指标）  
);  
-- sku_info表中包含spu_id(商品id)、sku_id(库存id)  
-- 通过sku_id可关联到对应的spu_id，从而将库存级别的数据聚合到商品级，便于从商品整体维度进行评估 -- sku_id 可成为连接各维度数据的关键，支撑商品诊断看板对商品表现的全面分析，进而辅助商家调整策略、优化运营  
-- spu_id可作为辅助维度用于商品集合层面的汇总分析  
insert overwrite table work_orders.spu_order  
    select   
    s.id as sku_id,  
    s.sku_name,  
    s.category3_id,  
    s.price,  
    count(distinct c.user_id) as cart_count,  
    count(distinct f.user_id) as favor_count,  
    sum(CAST(od.sku_num as int)) as order_num,  
    sum(od.order_price * CAST(od.sku_num as int)) as sales_amount,  
    -- 新客占比计算  
    (sum(case when datediff(o.create_time, u.create_time) <= 30 then 1 else 0 end )/ count(distinct o.user_id)) as new_user_ratio,  
    -- 好评率计算  
    (sum(case when ci.appraise = '1' then 1 else 0 end)/ count(distinct ci.id)) as good_comment_rate,  
    -- 退货率计算  
    (sum(CAST(ori.refund_num as int))/ sum(CAST(od.sku_num as int))) AS refund_rate  
from gmall.ods_sku_info s  
left join gmall.ods_cart_info c on s.id = c.sku_id  
left join gmall.ods_favor_info f on s.id = f.sku_id  
left join gmall.ods_order_detail od on s.id = od.sku_id  
left join gmall.ods_order_info o on od.order_id = o.id  
left join gmall.ods_user_info u on o.user_id = u.id  
left join gmall.ods_comment_info ci on s.id = ci.sku_id  
left join gmall.ods_order_refund_info ori on s.id = ori.sku_id  
group by s.id, s.sku_name, s.category3_id, s.price;
			
		
		
			
			